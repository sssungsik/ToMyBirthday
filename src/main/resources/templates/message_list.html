<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<head>
    <title th:text="${username} + 'ÎãòÏùò ÏºÄÏù¥ÌÅ¨'"></title>
</head>

<div layout:fragment="content">

    <div class="hero-top">
    </div>
    <div class="hero-list">
        <div class="infoBox p-2">
            <div class="infoBoxFlex">
                <h1 class="font-1-white hero-list-h3">
                    <mark th:text="${username}" class="cake-username"></mark>ÎãòÏùò ÏºÄÏù¥ÌÅ¨
                </h1>
                <a href="#" aria-label="Î©îÎâ¥Î≤ÑÌäº" class="btn-hamb" data-bs-toggle="offcanvas" data-bs-target="#sideMenu" aria-controls="sideMenu" style="margin-left: auto;">
                    <i class="bi bi-list fs-3"></i>
                </a>
            </div>
            <div class="message-length" th:each="m, i : ${messages}" th:if="${i.index < 1}">üíå
                <mark th:text="${i.size}" style="color: white; box-shadow: inset 0 -3px 0 pink; background: none; font-family: 'Pretendard'"></mark>Í∞úÏùò Î©îÏÑ∏ÏßÄÍ∞Ä ÎèÑÏ∞©ÌñàÏñ¥Ïöî.
            </div>
            <div th:if="${error}">
                <div class="message-length">üíå ÏïÑÏßÅ ÎèÑÏ∞©Ìïú Î©îÏÑ∏ÏßÄÍ∞Ä ÏóÜÏñ¥Ïöî.</div>
            </div>
            <div class="cakeImage">
                <img th:src="@{/assets/img/cake2.png}" alt="Cake">
            </div>
            <div><a href=""><b></b></a></div>

            <div id="messages-container">
                <div th:each="message, iterStat : ${messages}">
                    <div th:class="|overlay list${iterStat.index + 1}|">
                        <a th:text="${message.nickname}" class="font-2 message-link" th:href="@{|/message/${message.id}|}" data-toggle="modal" data-target="#messageDetailModal"></a>
                        <img th:src="@{/assets/img/candles/red.png}">
                    </div>
                </div>
            </div>

            <div class="paging">
                <div class="paging-form font-1-white">
                    <i id="prev-page" class="bi bi-chevron-double-left"></i>
                    <span id="page-info">1 / 1</span>
                    <i id="next-page" class="bi bi-chevron-double-right"></i>
                </div>
            </div>

            <div class="btnList">
                <button type="button" class="messageBtn hover-up" data-toggle="modal" data-target="#messageModal">
                    <i class="bi bi-magic"></i> Í∏Ä ÎÇ®Í∏∞Í∏∞</button>
                <button type="button" class="shareBtn hover-up" th:data-href="@{|/message?username=${username}|}" data-toggle="modal" data-target="#shareModal">
                    <i class="bi bi-share-fill"></i> Í≥µÏú†ÌïòÍ∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ (Offcanvas) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="sideMenu" aria-labelledby="sideMenuLabel">

        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sideMenuLabel"></h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <a class="nav-link" sec:authorize="isAnonymous()" th:href="@{/user/login}"><i class="bi bi-door-open"></i>„ÄÄÎ°úÍ∑∏Ïù∏</a>
            <a class="nav-link" sec:authorize="isAuthenticated()" th:href="@{/user/logout}"><i class="bi bi-box-arrow-in-right"></i>„ÄÄÎ°úÍ∑∏ÏïÑÏõÉ</a>
            <a class="nav-link" th:href="@{/user/signup}" target="_blank"><i class="bi bi-person-plus"></i>„ÄÄÌöåÏõêÍ∞ÄÏûÖ</a>
        </div>

    </div>


    <!-- Message Detail Modal -->
    <div class="modal fade" id="messageDetailModal" tabindex="-1" role="dialog" aria-labelledby="messageDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" id="messageDetail-modal">
                <div class="cardBackground">
                    <div class="cardBody">
                        <div class="modal-body">
                            <div id="messageDetailContent">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Write Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" id="message-modal-content">
                <div class="cardBackground">
                    <div class="cardBody">
                        <form id="messageForm" method="post" th:action="@{/message/new}">
                         <div class="modal-body">

                                <input type="hidden" name="username" th:value="${username}">
                                <div class="form-group" style="border-bottom: 1px solid">
                                    <label for="title" hidden="hidden">Title</label>
                                    <input type="text" style="font-size: 23px" class="form-control" id="title" name="title" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî." required>
                                </div>
                                <div class="form-group">
                                    <label for="content" hidden="hidden">Content</label>
                                    <textarea class="form-control" style="font-size: 20px" id="content" name="content" rows="3" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî." required></textarea>
                                </div>


                        </div>
                        <div class="modal-footer">
                            <div class="form-group text-start">
                                <label for="nickname">From.</label>
                                <input type="text" class="form-control"  style="font-size: 20px" id="nickname" name="nickname" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî." required>
                            </div>
                            <div class="form-group">
                            <button type="submit" class="btn btn-primary writeBtn" form="messageForm">Í∏Ä ÎÇ®Í∏∞Í∏∞</button>
                            </div>

                        </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" id="shareModalBox">
                <div class="modal-header shareModal-Top">
                    <h4>Í≥µÏú†</h4>
                    <div><h5 th:text="${username} + 'ÎãòÏùò ÏºÄÏù¥ÌÅ¨'"></h5></div>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="text" class="form-control" id="shareUrl" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary shareBtn2">Î≥µÏÇ¨</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ÌéòÏù¥Ïßï Í∏∞Îä•
            const messages = Array.from(document.querySelectorAll('#messages-container > div'));
            const messagesPerPage = 6;
            let currentPage = 0;

            function showPage(page) {
                const start = page * messagesPerPage;
                const end = start + messagesPerPage;
                messages.forEach((msg, index) => {
                    msg.style.display = (index >= start && index < end) ? 'block' : 'none';
                });
                document.getElementById('page-info').textContent = `${page + 1} / ${Math.ceil(messages.length / messagesPerPage)}`;
                document.getElementById('prev-page').style.display = page === 0 ? 'none' : 'inline';
                document.getElementById('next-page').style.display = end >= messages.length ? 'none' : 'inline';
            }

            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    showPage(currentPage);
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                if ((currentPage + 1) * messagesPerPage < messages.length) {
                    currentPage++;
                    showPage(currentPage);
                }
            });

            showPage(currentPage);

            // Î©îÏãúÏßÄ ÏÉÅÏÑ∏ ÎÇ¥Ïö© Î≥¥Í∏∞
            document.querySelectorAll('.message-link').forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault(); // Í∏∞Î≥∏ ÎßÅÌÅ¨ ÌÅ¥Î¶≠ ÎèôÏûë Î∞©ÏßÄ
                    const url = this.getAttribute('href');

                    // AJAX ÏöîÏ≤≠
                    fetch(url)
                        .then(response => response.text())
                        .then(html => {
                            // Î™®Îã¨Ïùò ÏΩòÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏
                            document.getElementById('messageDetailContent').innerHTML = html;
                            // Î™®Îã¨ Ïó¥Í∏∞
                            $('#messageDetailModal').modal('show');
                        })
                        .catch(error => console.error('Error fetching message detail:', error));
                });
            });

            // Í≥µÏú† URL ÏÑ§Ï†ï
            const shareButton = document.querySelector('.shareBtn');
            const shareUrlInput = document.getElementById('shareUrl');

            shareButton.addEventListener('click', function () {
                // Get URL from data-href attribute
                const url = this.getAttribute('data-href');
                // Set the URL to the input field in the modal
                shareUrlInput.value = url;
            });

            // Î™®Îã¨ Îã´Í∏∞ Ïãú Î∞∞Í≤Ω Ï†úÍ±∞ Î∞è Ï¥àÍ∏∞Ìôî
            $('#messageDetailModal, #shareModal').on('hidden.bs.modal', function () {
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            });

            const shareBtn2 = document.querySelector('.shareBtn2');
            const shareUrlInput2 = document.getElementById('shareUrl');
            const copyMessage = document.getElementById('copyMessage');

            shareBtn2.addEventListener('click', function() {
                // Select the text in the input field
                shareUrlInput.select();
                shareUrlInput.setSelectionRange(0, 99999); // For mobile devices

                // Copy the text to the clipboard
                document.execCommand('copy');

                // Show the copy confirmation message
                copyMessage.style.display = 'block';

                // Hide the message after 2 seconds
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                }, 2000);
            });
        });
    </script>

</div>

</html>
